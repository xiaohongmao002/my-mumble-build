name: Build Mumble v1.5.735 Full

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Mumble Source
        uses: actions/checkout@v4
        with:
          repository: mumble-voip/mumble
          ref: v1.5.735
          submodules: recursive
          fetch-depth: 1

      - name: Install All Potential Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          build-essential cmake pkg-config \
          qtbase5-dev qttools5-dev qttools5-dev-tools \
          libqt5svg5-dev libqt5x11extras5-dev qtmultimedia5-dev \
          libqt5dbus5 qttools5-private-dev \
          libboost-dev libssl-dev libprotobuf-dev protobuf-compiler \
          libcap-dev libsndfile1-dev libspeex-dev libspeexdsp-dev \
          libopus-dev libavahi-compat-libdnssd-dev libzeroc-ice-dev \
          libasound2-dev libpulse-dev libjack-jackd2-dev libxi-dev \
          libxext-dev sqlite3 libpoco-dev libspeechd-dev \
          libev-dev libxcb-xinerama0-dev libxcb-xkb-dev libxkbcommon-x11-dev \
          libx11-xcb-dev libxkbcommon-dev

      - name: Configure and Build
        run: |
          mkdir build && cd build
          # 策略：如果 LinguistTools 还是找不到，我们通过 CMAKE_PREFIX_PATH 强行指路
          # 同时关闭一些极端边缘且容易报错的模块（如测试、插件和覆盖层）
          cmake -Dserver=all \
                -Dclient=all \
                -Dtests=OFF \
                -Doverlay=OFF \
                -Dplugins=OFF \
                -Dtranslations=ON \
                -DCMAKE_BUILD_TYPE=Release ..
          
          # 使用多核编译
          make -j$(nproc)

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: mumble-1.5.735-ubuntu22-final
          path: |
            build/mumble-server
            build/mumble
