name: Build Mumble v1.5.735

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Mumble Source
        uses: actions/checkout@v4
        with:
          repository: mumble-voip/mumble
          ref: v1.5.735
          submodules: recursive
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config qtbase5-dev qttools5-dev-tools \
          libqt5svg5-dev libqt5x11extras5-dev qtmultimedia5-dev libboost-dev libssl-dev \
          libprotobuf-dev protobuf-compiler libcap-dev libsndfile1-dev libspeex-dev \
          libspeexdsp-dev libopus-dev libavahi-compat-libdnssd-dev libzeroc-ice-dev \
          libasound2-dev libpulse-dev libjack-jackd2-dev libxi-dev libxext-dev sqlite3 \
          libpoco-dev \
          libspeechd-dev # <--- 修复这次的错误：文本转语音依赖

      - name: Configure and Build
        run: |
          mkdir build && cd build
          # 同时编译服务端和客户端
          # 加上 -Dplugins=OFF 和 -Doverlay=OFF 可以跳过一些容易出错的次要组件
          cmake -Dserver=all -Dclient=all -Dtests=OFF -Doverlay=OFF -Dplugins=OFF ..
          make -j$(nproc)

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: mumble-1.5.735-ubuntu22
          path: |
            build/mumble-server
            build/mumble
